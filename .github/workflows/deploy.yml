name: éƒ¨ç½²åˆ°GitHub Pages

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½ä»£ç 
        uses: actions/checkout@v4
        
      - name: å®‰è£…Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ ä½¿ç”¨Node.js $(node --version)"
          rm -rf node_modules
          npm install
          
      - name: ğŸ”§ ä¿®å¤VitePressæ¨¡å—å¯¼å…¥
        run: |
          echo "ğŸ”§ ä¿®å¤VitePresså¯¼å…¥bug..."
          
          # æ–‡ä»¶è·¯å¾„
          INDEX_FILE="node_modules/vitepress/dist/client/theme-default/index.js"
          
          if [ -f "$INDEX_FILE" ]; then
            echo "ğŸ“„ æ‰¾åˆ°index.jsæ–‡ä»¶"
            
            # æŸ¥çœ‹å½“å‰å¯¼å…¥è¯­å¥
            echo "å½“å‰å¯¼å…¥è¯­å¥:"
            grep -n "without-fonts" "$INDEX_FILE" || echo "æœªæ‰¾åˆ°ç›¸å…³å¯¼å…¥"
            
            # ä¿®å¤1: ç¡®ä¿æœ‰.jsæ‰©å±•å
            echo "ğŸ”„ ä¿®å¤å¯¼å…¥æ‰©å±•å..."
            
            # ä½¿ç”¨sedä¿®å¤æ‰€æœ‰å¯èƒ½çš„å¯¼å…¥æ–¹å¼
            sed -i "s|from './without-fonts'|from './without-fonts.js'|g" "$INDEX_FILE"
            sed -i "s|from \"./without-fonts\"|from \"./without-fonts.js\"|g" "$INDEX_FILE"
            sed -i "s|import('./without-fonts')|import('./without-fonts.js')|g" "$INDEX_FILE"
            sed -i "s|import(\"./without-fonts\")|import(\"./without-fonts.js\")|g" "$INDEX_FILE"
            
            # ä¿®å¤2: ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”æœ‰å†…å®¹
            FONT_FILE="node_modules/vitepress/dist/client/theme-default/without-fonts.js"
            if [ -f "$FONT_FILE" ]; then
              echo "âœ… without-fonts.jsæ–‡ä»¶å­˜åœ¨"
              # ç¡®ä¿æ–‡ä»¶æœ‰å¯¼å‡º
              if ! grep -q "export" "$FONT_FILE"; then
                echo "ğŸ”„ æ·»åŠ å¯¼å‡ºè¯­å¥"
                echo "export default {};" >> "$FONT_FILE"
              fi
            else
              echo "ğŸ”„ åˆ›å»ºç¼ºå¤±æ–‡ä»¶"
              mkdir -p "$(dirname "$FONT_FILE")"
              echo "export default {};" > "$FONT_FILE"
            fi
            
            # éªŒè¯ä¿®å¤
            echo "âœ… ä¿®å¤åå¯¼å…¥è¯­å¥:"
            grep -n "without-fonts" "$INDEX_FILE"
            
          else
            echo "âŒ index.jsæ–‡ä»¶ä¸å­˜åœ¨"
            # åˆ—å‡ºç›®å½•ç»“æ„
            echo "ç›®å½•å†…å®¹:"
            find "node_modules/vitepress/dist/client/theme-default" -type f | head -10
          fi
          
      - name: ğŸ—ï¸ æ„å»ºç½‘ç«™
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»º..."
          
          # è°ƒè¯•ï¼šæŸ¥çœ‹å®é™…æ‰§è¡Œçš„æ„å»ºå‘½ä»¤
          echo "æ„å»ºå‘½ä»¤: npm run docs:build"
          
          # æ‰§è¡Œæ„å»º
          npm run docs:build || {
            echo "âŒ æ ‡å‡†æ„å»ºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
            
            # å¤‡ç”¨æ–¹æ¡ˆ1: ä½¿ç”¨npx
            npx vitepress build docs --force || {
              echo "âŒ npxæ„å»ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰§è¡Œ..."
              
              # å¤‡ç”¨æ–¹æ¡ˆ2: ç›´æ¥è¿è¡Œè„šæœ¬
              node node_modules/vitepress/bin/vitepress.js build docs
            }
          }
          
      - name: éƒ¨ç½²
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vitepress/dist