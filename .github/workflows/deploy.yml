name: éƒ¨ç½²åˆ°GitHub Pages

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½ä»£ç 
        uses: actions/checkout@v4
        
      - name: å®‰è£…Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–ï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆè§£å†³peerä¾èµ–å†²çªï¼‰"
          rm -rf node_modules
          # ä½¿ç”¨--legacy-peer-depså¿½ç•¥peerä¾èµ–è­¦å‘Š
          npm install --legacy-peer-deps
          
      - name: ğŸ”§ ä¿®å¤VitePress 1.6.4å…¼å®¹æ€§é—®é¢˜
        run: |
          echo "ğŸ”§ ä¿®å¤VitePress 1.6.4åœ¨Node.js v22ä¸‹çš„é—®é¢˜..."
          
          # 1. ä¿®å¤without-fontså¯¼å…¥
          INDEX_FILE="node_modules/vitepress/dist/client/theme-default/index.js"
          if [ -f "$INDEX_FILE" ]; then
            echo "ğŸ“„ ä¿®å¤index.jsä¸­çš„å¯¼å…¥..."
            sed -i "s|from './without-fonts'|from './without-fonts.js'|g" "$INDEX_FILE"
            sed -i "s|from \"./without-fonts\"|from \"./without-fonts.js\"|g" "$INDEX_FILE"
          fi
          
          # 2. ç¡®ä¿without-fonts.jsæ–‡ä»¶å­˜åœ¨
          FONT_FILE="node_modules/vitepress/dist/client/theme-default/without-fonts.js"
          if [ ! -f "$FONT_FILE" ]; then
            echo "ğŸ“„ åˆ›å»ºwithout-fonts.js..."
            mkdir -p "$(dirname "$FONT_FILE")"
            echo "export default {};" > "$FONT_FILE"
          fi
          
          # 3. ä¿®å¤CSSå¯¼å…¥é—®é¢˜ - å…³é”®æ­¥éª¤ï¼
          echo "ğŸ¨ ä¿®å¤CSSå¯¼å…¥é—®é¢˜..."
          
          # æ–¹æ³•ï¼šåœ¨æ‰€æœ‰JSæ–‡ä»¶ä¸­å°†.csså¯¼å…¥æ”¹ä¸ºç©ºå¯¼å…¥
          find node_modules/vitepress -name "*.js" -type f | while read file; do
            if grep -q "\.css" "$file"; then
              # å¤‡ä»½åŸæ–‡ä»¶
              cp "$file" "$file.bak"
              # æ›¿æ¢.csså¯¼å…¥
              sed -i "s|import ['\"][^'\"]*\.css['\"]|// CSS import removed for Node.js v22 compatibility|g" "$file"
              sed -i "s|from ['\"][^'\"]*\.css['\"]|from './empty-module.js'|g" "$file"
            fi
          done
          
          # 4. åˆ›å»ºç©ºçš„CSSæ¨¡å—
          echo "// Empty CSS module for Node.js v22 compatibility" > node_modules/vitepress/dist/client/theme-default/styles/empty-module.js
          echo "export default {};" >> node_modules/vitepress/dist/client/theme-default/styles/empty-module.js
          
          # 5. åˆ›å»ºpackage.jsonè®©Node.jsçŸ¥é“è¿™æ˜¯ESæ¨¡å—
          echo '{"type":"module"}' > node_modules/vitepress/dist/client/theme-default/styles/package.json
          
      - name: ğŸ—ï¸ æ„å»ºç½‘ç«™
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»º..."
          
          # è®¾ç½®NODE_OPTIONSç¯å¢ƒå˜é‡
          export NODE_OPTIONS="--experimental-vm-modules --no-warnings"
          
          # å°è¯•æ„å»º
          npm run docs:build || {
            echo "âš ï¸ æ ‡å‡†æ„å»ºå¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ..."
            
            # æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨æ›´å®½æ¾çš„ç¯å¢ƒå˜é‡
            NODE_OPTIONS="--loader @node-loader/babel" npx vitepress build docs --force
          }
          
      - name: éƒ¨ç½²
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vitepress/dist